# Automated Patch Assessment for Program Repair at Scale (paper under review)
In this repository, we do automatic correctness assessment for patches generated by program repair techniques. We consider the human patch as ground truth oracle and use Random tests with Ground Truth(RGT).


## Folder Structure
 ```bash
├── Patches 257 patches from Dcorrect and 381 patches from Doverfitting
│ 
├── RGT: incl. tests from Evosuite2019, Randoop2019, EvosuitASE15, RandoopASE15 and EvosuiteEMSE18
│   
├── DiffTGen
│   ├── Results: the running result overfitting patches found by DiffTGen. 
│   ├── runDrr.py: a command to reproduce DiffTGen experiment(details see below)
│ 
├── statistics: our exerimental statistics for all RQs
│ 
└──  drr.py: a command to reproduce all experiments
```


## Setup Experiment Environment
* JDK 1.7
* OS: Linux and Mac
* Configure the DEFECTS4J_HOME="home_of_defects4j"

### Add submodule defects4j and checkout the commit 486e2b4(Please note our experiment depends on several Defects4J commands)
```
git submodule add https://github.com/rjust/defects4j
git reset --hard 486e2b49d806cdd3288a64ee3c10b3a25632e991
```
### Patches
[patches_overview.csv](https://github.com/kth-tcs/defects4-repair-reloaded/blob/master/statistics/patches_overview.csv), an overview of patches. Update it with following command:
```
./drr.py patches_overview
```
To perform sanity checks with following command:

```
./run.py applicable_check
./run.py plausible_check
```

### RGT

* The RGT tests generation log for [Evosuite2019](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RGT_Evosuite2019_Generation_Log.csv) and [Randoop2019](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RGT_Randoop2019_Generation_Log.csv). 
* Individually, Evosuite2019 and Randoop2019 fail to generate cases for 31/3510  and 1080/3510 executions. There are respective 2.2% and 2.4% falky tests are found, please see the log [Flaky_Check_For_Evosuite2019](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RGT_Evosuite2019_Flaky_Check.csv) and [Flaky_Check_For_Randoop2019](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RGT_Randoop2019_Flaky_Check.csv).



## How to automatically assess patch correctness? We provide following commands:
Patch Assessment:
```
./run.py patch_assessment <patch_id> <dataset:Dcorrect|Doverfitting> <RGT:ASE15_Evosuite|ASE15_Randoop|EMSE18_Evosuite|2019_Evosuite|2019_Randoop>  
example:  ./run.py patch_assessment patch1-Lang-35-ACS.patch Dcorrect 2019_Evosuite
```
Determine Flaky Tests:
```
./run.py flaky_check <patch_id> <dataset:Dcorrect|Doverfitting> <RGT:ASE15_Evosuite|ASE15_Randoop|EMSE18_Evosuite|2019_Evosuite|2019_Randoop>  
example:  ./run.py flaky_check patch1-Lang-35-ACS.patch Dcorrect 2019_Evosuite
```
Determine Flaky Tests and Remove Them
```
./run.py flaky_check <patch_id> <dataset:Dcorrect|Doverfitting> <RGT:ASE15_Evosuite|ASE15_Randoop|EMSE18_Evosuite|2019_Evosuite|2019_Randoop>  
example:  ./run.py flaky_check_and_remove patch1-Lang-35-ACS.patch Dcorrect 2019_Evosuite
```
Reproduce Our Expriment with RGT patch assessment
```
RQ1: ./run.py RQ1
RQ3: ./run.py RQ3
RQ4: ./run.py RQ4
RQ5: cd ./statistics   ./RQ5-randomness-script.py  <Evosuite2019|Randoop2019>
```

We improve DiffTGen to automate this tool for overfitting patch identification
```
cd DiffTGen
pwd (customize the abosulte DiffTGen path to run file)
ant compile
./runDrr.py all path_of_diffTgen
```


## Result of RQ1/2
RGT patch assessment contradicts previously done manual analysis and false positives.
* The 10 patches from previous research classified as correct by their respective authors are actually overfitting.
* We run Evosuite2019 and Randoop2019 over 257 patches from Dcorrect. The statistics for each test execution is available at [RQ1 and 2_Result](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RG1-2_Result.csv).

## Result of RQ3
Effectiveness of RGT compared to DiffTGen.
* The detailed execution logs are available at [Evosuite2019_Execution_on_Doverfitting](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ3-Evosuite2019-Result.txt) and [Randoop2019_Execution_on_Doverfitting](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ3-Randoop2019-Result.txt)
* Overfitting patches found by Evosite2019 and Randoop2019 are individally summarized in the [statistics](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ3_Overfitting_Patches.csv).Together, they found 274 overfitting patches. 
* Overfitting patches found by DiffTGen is summarized in the [DiffTGen Result](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/DiffTGen/Result.csv).
<img src="https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ3_Venn.jpg" width="280" height="240">

## Result of RQ4
Time cost of RGT.
* Overfitting patches found by RGT from previous research: EvosuiteASE15, RandoopASE15, EvosuiteEMSE18 are summarized [here](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ4_Patches_Found_by_Previous_RGT.csv).
* Experiment statistics of [RQ4_RGT_From_Previous_on_Dcorrect.csv](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ4_RGT_From_Previous_on_Dcorrect.csv): 9 misclassified patches found. 
* Experiment statistics of [RQ4_RGT_From_Previous_on_Doverfitting.csv](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ4_RGT_From_Previous_on_Doverfitting.csv): 219 misclassified patches found. 

## Result of RQ5
Trade-off between test generation and effectiveness of RGT
* Individually, the failure number for 30 RGT tests of identifying overfitting patches are available [Evosuite2019](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ5-Evosuite_Raw_Statistics.txt) and [Randoop2019](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ5-Randoop_Raw_Statistics.csv).
* We develop a [script](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ5-randomness-script.py) to simulate 1000 random groups that each contain 30 runs test generation. 
* Statistics that record the average test generations that achieve effectiveness of 80%, 85%, 90%, 95% and 100%: [1000 groups of Evosuite](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ5-1000-groups-evosuite.csv) and [1000 groups of Randoop](https://github.com/kth-tcs/defects4j-repair-reloaded/blob/master/statistics/RQ5-1000-groups-randoop.csv).


## Credits

* For more details about Defects4J, see the original repository of the [Defects4J benchmark](https://github.com/rjust/defects4j).
* For more details about DiffTGen, see the original repository of the [DiffTGen](https://github.com/qixin5/DiffTGen).


